name: Build and Deploy ðŸš€

on:
  push:
    branches:
      - main
      - Dev
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    steps:
      - name: deploy via ssh
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.SSH_KEY_GITHUB_WIZIA }}
          port: ${{ secrets.DEPLOY_PORT }}
          script: |
            cd /home/${{ secrets.DEPLOY_USER }}/DockerApps/Lean_Start_UP_WIZIA
            docker compose down
            rm -rf /home/${{ secrets.DEPLOY_USER }}/DockerApps/Lean_Start_UP_WIZIA
            cd /home/${{ secrets.DEPLOY_USER }}/DockerApps
            GIT_SSH_COMMAND="ssh -i ~/.ssh/github_auth" git clone git@github.com:MatthieuQuerel/Lean_Start_UP_WIZIA.git
            cd /home/${{ secrets.DEPLOY_USER }}/DockerApps/Lean_Start_UP_WIZIA
            echo "APP_NAME=Wizia" > .env
            echo "APP_ENV=local" >> .env
            echo "APP_KEY=base64:99YIxVdtX4sTr4l+QfAUURCzsAxoiWtKaOXj9/+Fj10=" >> .env
            echo "APP_DEBUG=true" >> .env
            echo "APP_URL=https://wizia.beziu.dev" >> .env
            echo "APP_LOCALE=en" >> .env
            echo "APP_FALLBACK_LOCALE=en" >> .env
            echo "APP_FAKER_LOCALE=en_US" >> .env
            echo "APP_MAINTENANCE_DRIVER=file" >> .env
            echo "PHP_CLI_SERVER_WORKERS=4" >> .env
            echo "BCRYPT_ROUNDS=12" >> .env
            echo "LOG_CHANNEL=stack" >> .env
            echo "LOG_STACK=single" >> .env
            echo "LOG_DEPRECATIONS_CHANNEL=null" >> .env
            echo "LOG_LEVEL=debug" >> .env
            echo "DB_CONNECTION=mysql" >> .env
            echo "DB_HOST=wizia-db" >> .env
            echo "DB_PORT=3306" >> .env
            echo "DB_DATABASE=${{ secrets.DB_DATABASE }}" >> .env
            echo "DB_USERNAME=${{ secrets.DB_USERNAME }}" >> .env
            echo "DB_PASSWORD=${{ secrets.DB_PASSWORD }}" >> .env
            echo "SESSION_DRIVER=database" >> .env
            echo "SESSION_LIFETIME=120" >> .env
            echo "SESSION_ENCRYPT=false" >> .env
            echo "SESSION_PATH=/" >> .env
            echo "SESSION_DOMAIN=null" >> .env
            echo "BROADCAST_CONNECTION=log" >> .env
            echo "FILESYSTEM_DISK=local" >> .env
            echo "QUEUE_CONNECTION=database" >> .env
            echo "CACHE_STORE=database" >> .env
            echo "MEMCACHED_HOST=127.0.0.1" >> .env
            echo "REDIS_CLIENT=phpredis" >> .env
            echo "REDIS_HOST=127.0.0.1" >> .env
            echo "REDIS_PASSWORD=null" >> .env
            echo "REDIS_PORT=6379" >> .env
            echo "MAIL_MAILER=log" >> .env
            echo "MAIL_SCHEME=null" >> .env
            echo "MAIL_HOST=${{ secrets.MAIL_HOST }}" >> .env
            echo "MAIL_PORT=${{ secrets.MAIL_PORT }}" >> .env
            echo "MAIL_USERNAME=${{ secrets.MAIL_USERNAME }}" >> .env
            echo "MAIL_PASSWORD=${{ secrets.MAIL_PASSWORD }}" >> .env
            echo "MAIL_FROM_ADDRESS=${{ secrets.MAIL_FROM_ADDRESS }}" >> .env
            echo "MAIL_FROM_NAME=\${APP_NAME}" >> .env
            echo "AWS_ACCESS_KEY_ID=" >> .env
            echo "AWS_SECRET_ACCESS_KEY=" >> .env
            echo "AWS_DEFAULT_REGION=us-east-1" >> .env
            echo "AWS_BUCKET=" >> .env
            echo "AWS_USE_PATH_STYLE_ENDPOINT=false" >> .env
            echo "VITE_APP_NAME=\${APP_NAME}" >> .env
            echo "KEY_API_GEMINI=${{ secrets.KEY_API_GEMINI }}" >> .env
            echo "key_API_GPT=${{ secrets.key_API_GPT }}" >> .env
            echo "KeyMake=${{ secrets.keyMake }}" >> .env
            echo "MAIL_FROM_NAME=\"\${APP_NAME}\"" >> .env
            echo "AWS_ACCESS_KEY_ID=" >> .env
            echo "AWS_SECRET_ACCESS_KEY=" >> .env
            echo "AWS_DEFAULT_REGION=us-east-1" >> .env
            echo "AWS_BUCKET=" >> .env
            echo "AWS_USE_PATH_STYLE_ENDPOINT=false" >> .env
            echo "VITE_APP_NAME=\"\${APP_NAME}\"" >> .env
            echo "KEY_API_GEMINI=${{ secrets.KEY_API_GEMINI }}" >> .env
            echo "key_API_GPT=${{ secrets.key_API_GPT }}" >> .env
            echo "KeyMake=${{ secrets.keyMake }}" >> .env
            composer install
            docker compose up -d
            docker system prune -f