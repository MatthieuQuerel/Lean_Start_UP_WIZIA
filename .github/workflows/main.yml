name: Lint, Build and Deploy ðŸš€

on:
  pull_request:
    branches:
      - main
    types:
      - closed
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  lint:
    runs-on: ubuntu-latest
    name: Lint Code Base
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: json, dom, curl, libxml, mbstring
          coverage: none

      - name: Install dependencies
        run: composer install --prefer-dist --no-ansi --no-interaction --no-progress --no-scripts

      - name: Execute Pint
        run: ./vendor/bin/pint --format=checkstyle

  build-and-push:
    runs-on: ubuntu-latest
    needs: lint
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to the Container registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for App
        id: meta-app
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/app
          tags: |
            type=raw,value=latest,enable={{is_default_branch}}
            type=sha

      - name: Build and push App image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile.prod
          push: true
          tags: ${{ steps.meta-app.outputs.tags }}
          labels: ${{ steps.meta-app.outputs.labels }}

      - name: Extract metadata for Nginx
        id: meta-nginx
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/nginx
          tags: |
            type=raw,value=latest,enable={{is_default_branch}}
            type=sha

      - name: Build and push Nginx image
        uses: docker/build-push-action@v5
        with:
          context: docker/nginx
          push: true
          tags: ${{ steps.meta-nginx.outputs.tags }}
          labels: ${{ steps.meta-nginx.outputs.labels }}

  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    needs: build-and-push
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: deploy via ssh
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.SSH_KEY_GITHUB_WIZIA }}
          port: ${{ secrets.DEPLOY_PORT }}
          script: |
            cd /home/${{ secrets.DEPLOY_USER }}/DockerApps/Lean_Start_UP_WIZIA
            
            # Login to GHCR (if needed, otherwise rely on public helper/token if configured)
            # Since we can't easily pass the token securely without another secret, we assume public read or pre-auth.
            
            # Create/Overwrite docker-compose.yml
            cat <<EOF > docker-compose.yml
            $(cat docker-compose.prod.yml)
            EOF
            
            # Update .env
            echo "APP_NAME=Wizia" > .env
            echo "APP_ENV=production" >> .env
            echo "APP_KEY=base64:99YIxVdtX4sTr4l+QfAUURCzsAxoiWtKaOXj9/+Fj10=" >> .env
            echo "APP_DEBUG=false" >> .env
            echo "APP_URL=https://wizia.beziau.dev" >> .env
            
            # Add Github Repository Lowercased for Image reference
            REPO_LOWER=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
            echo "GITHUB_REPOSITORY=\$REPO_LOWER" >> .env
            
            # Other env vars
            echo "APP_LOCALE=en" >> .env
            echo "APP_FALLBACK_LOCALE=en" >> .env
            echo "APP_MAINTENANCE_DRIVER=file" >> .env
            echo "PHP_CLI_SERVER_WORKERS=4" >> .env
            echo "BCRYPT_ROUNDS=12" >> .env
            echo "LOG_CHANNEL=stack" >> .env
            echo "LOG_STACK=single" >> .env
            echo "LOG_DEPRECATIONS_CHANNEL=null" >> .env
            echo "LOG_LEVEL=debug" >> .env
            echo "DB_CONNECTION=mysql" >> .env
            echo "DB_HOST=wizia-db" >> .env
            echo "DB_PORT=3306" >> .env
            echo "DB_DATABASE=${{ secrets.DB_DATABASE }}" >> .env
            echo "DB_USERNAME=${{ secrets.DB_USERNAME }}" >> .env
            echo "DB_PASSWORD=${{ secrets.DB_PASSWORD }}" >> .env
            echo "SESSION_DRIVER=database" >> .env
            echo "SESSION_LIFETIME=120" >> .env
            echo "SESSION_ENCRYPT=false" >> .env
            echo "SESSION_PATH=/" >> .env
            echo "SESSION_DOMAIN=null" >> .env
            echo "BROADCAST_CONNECTION=log" >> .env
            echo "FILESYSTEM_DISK=local" >> .env
            echo "QUEUE_CONNECTION=database" >> .env
            echo "CACHE_STORE=database" >> .env
            echo "MEMCACHED_HOST=127.0.0.1" >> .env
            echo "REDIS_CLIENT=phpredis" >> .env
            echo "REDIS_HOST=127.0.0.1" >> .env
            echo "REDIS_PASSWORD=null" >> .env
            echo "REDIS_PORT=6379" >> .env
            echo "MAIL_MAILER=log" >> .env
            echo "MAIL_SCHEME=null" >> .env
            echo "MAIL_HOST=${{ secrets.MAIL_HOST }}" >> .env
            echo "MAIL_PORT=${{ secrets.MAIL_PORT }}" >> .env
            echo "MAIL_USERNAME=${{ secrets.MAIL_USERNAME }}" >> .env
            echo "MAIL_PASSWORD=${{ secrets.MAIL_PASSWORD }}" >> .env
            echo "MAIL_ENCRYPTION='${{ secrets.MAIL_ENCRYPTION }}'" >> .env
            echo "MAIL_FROM_ADDRESS=${{ secrets.MAIL_FROM_ADDRESS }}" >> .env
            echo "MAIL_FROM_NAME=\${APP_NAME}" >> .env
            echo "AWS_ACCESS_KEY_ID=" >> .env
            echo "AWS_SECRET_ACCESS_KEY=" >> .env
            echo "AWS_DEFAULT_REGION=us-east-1" >> .env
            echo "AWS_BUCKET=" >> .env
            echo "AWS_USE_PATH_STYLE_ENDPOINT=false" >> .env
            echo "VITE_APP_NAME=\${APP_NAME}" >> .env
            echo "KEY_API_GEMINI=${{ secrets.KEY_API_GEMINI }}" >> .env
            echo "key_API_GPT=${{ secrets.key_API_GPT }}" >> .env
            echo "KeyMake=${{ secrets.keyMake }}" >> .env
            
            # Pull and restart
            # Note: docker compose pull might need authentication if the package is private.
            docker compose pull
            docker compose down
            docker compose up -d
            docker system prune -f